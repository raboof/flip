<html>
  <head>
    <style>
      .frame {
        float: left;
      }
      .frame img {
        width: 70%;
      }
    </style>
    <style media="print">
      #my_camera {
        display: none;
      }

      #controls {
        display: none;
      }

      #show {
        display: none;
      }
    </style>
  </head>
  <body>
    <script src="jquery-2.2.3.min.js"></script>
    <script src="webcam.js"></script>

    <div id="my_camera" style="float: left; width:320px; height:240px;"></div>
    <div id="controls">
        <form>
            Total frames: <input id="frames" type="number" value="32"><br>
            Frames per row: <input id="framesperrow" type="number" value="4"><br>
            Frame rate: <input id="rate" type="number" value="350">
        </form>
    </div>
    <div style="clear: both"/>
    <div id="my_result"></div>

    <script language="JavaScript">
        Webcam.attach('#my_camera');

        function make_movie() {
            $('#make').hide();
            $('#my_camera').show();
            record_movie(0)
        }

        function record_movie(frame) {
            var width = (window.innerWidth - 30) / $('#framesperrow').val();
            var prewidth = width * 1 / 3;
            var imgwidth = width * 2 / 3;
            var height = Math.floor(imgwidth * 240 / 320)
            console.log('width, height, prewidth', width, height, prewidth);
            Webcam.snap(function(data_uri, snappedcanvas, snappedctx) {
		if (frame % $('#framesperrow').val() == 0) {
                  var canvasId = 'frame' + frame;
                  $('<canvas>').attr({
                    id: canvasId,
                    width: ($('#framesperrow').val() * width) + 'px',
                    height: height + 'px'
                  }).appendTo('#my_result')
                }
                var canvas = $('#my_result canvas:last')[0];
                var offset = (frame % $('#framesperrow').val()) * width;
                console.log('offset', offset);
                var context = canvas.getContext("2d");
                context.fillStyle = 'blue';
                context.font = 'bold 16px sans';
                context.fillText(frame+1, offset, height / 2);
                context.drawImage(snappedcanvas, offset + prewidth, 0, imgwidth, height);
            } );
            if (frame < $('#frames').val() - 1) {
                window.setTimeout(record_movie, $('#rate').val(), frame + 1);
            } else {
                $('#my_camera').hide();
                $('#controls').hide();
                $('#make').hide();
                $('#show').show();
            }
        }

        function show_controls() {
            $('#my_camera').show();
            $('#controls').show();
            $('#make').show();
            $('#show').hide();
            $('#my_result').empty();
        }

    </script>
    <div style="clear: both">
    <a id="make" href="javascript:void(make_movie())">Make movie!</a>
    <a id="show" style="display: none" href="javascript:void(show_controls())">Another one!</a>
  </body>
</html>
